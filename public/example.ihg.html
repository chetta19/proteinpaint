<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
</head>
<body>

<script src="bin/proteinpaint.js" charset="utf-8"></script>

<noscript>This page requires JavaScript. Please enable it in your browser settings.</noscript>

<div id=aaa style="margin:10px"></div>
<div id=exp style="margin:10px"></div>

<script>
    document.body.onload = () => runproteinpaint({
        //host: 'https://ppr.stjude.org',
        holder: document.getElementById('aaa'),
        parseurl: true,
        nobox: 1,
        noheader: 1,
        debug: 1,
        mass: {
            state: {
                dslabel: 'IHG',
                genome: 'hg19',
                /*   termfilter: {
                     filter: {
                       type: 'tvslst',
                       lst: [{
                         type: 'tvs',
                         tvs: {
                           term: {id: 'Sample Type'},
                           values: [{key: 'D1'}]
                         }
                       }]
                     }
                   },*/
                plots: [
                    {
                        chartType: 'matrix',
                        settings: {
                            matrix: {
                                colw: 8,
                                colspace: 0,
                                rowspace: 0,
                                termLabelOffset: 220,
                                sortTermsBy: 'asListed',
                                grpLabelFontSize: 13,
                                //sampleNameFilter: '_D1$'
                            }
                        },
                        menuOpts: {
                            sampleGroup: [
                                {
                                    label: 'Survival plot',
                                    callback: 'launchSurvivalPlot',
                                    config: {
                                        //term2: {id: 'Primary Treatment category 2'},
                                        settings: {
                                            survival: {
                                                xTickValues: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30]
                                            }
                                        }
                                    }
                                }
                            ]
                        },
                        /*divideBy: {
                            id: 'TSNE Category'
                        },*/
                        termgroups: [
                            {
                                name: '',
                                lst: [
                                    {
                                        id: 'Age',
                                        q: {
                                            mode: 'continuous',
                                        },
                                        settings: {
                                            barh: 40,
                                            gap: 10
                                        }
                                    },
                                    {
                                        label: 'Age Group',
                                        id: 'Age',
                                        q: {
                                            mode: 'discrete',
                                            type: 'custom-bin',
                                            lst: [{
                                                label: '<3',
                                                startunbounded: true,
                                                startinclusive: true,
                                                stopinclusive: false,
                                                stop: 3
                                            }, {
                                                label: '3 to <7',
                                                startinclusive: true,
                                                stopinclusive: false,
                                                start: 3,
                                                stop: 7
                                            }, {
                                                label: '7 to 18',
                                                startinclusive: true,
                                                stopinclusive: false,
                                                start: 7,
                                                stopunbounded: true,
                                            }]
                                        }
                                    },
                                    {
                                        id: 'Gender',
                                        q: { mode: 'values' } // or 'groupsetting'
                                    },
                                    { id: 'Anatomical Location of Tumor Tier 2' },
                                    { id: 'Extent of Resection-2' },
                                    { id: 'M0/M+' },
                                    { id: 'Primary Treatment' },
                                    { id: 'Risk Category' },
                                    { id: 'Progresssive Disease' },
                                    { id: 'Radiation Used' },
                                    { id: 'Histology at Diagnosis' },
                                    { id: 'MNP Classifier' },
                                    { id: 'Integrated Diagnosis Tier 1' },
                                    { id: 'Integrated Diagnosis Tier 2' },
                                    { id: 'Integrated Diagnosis Tier 3' },
                                    { id: 'Methylation' },
                                    { id: 'RNA-Seq' },
                                    { id: 'WES' },
                                ]
                            },
                            {
                                name: 'Cytogenetics',
                                lst: getCytogeneticsData()
                            },
                            {
                                name: 'FISH/IHC',
                                lst: [{ id: 'ALK_FISH', legend: { group: 'FISH/IHC' } },
                                { id: 'BRAF_FISH', legend: { group: 'FISH/IHC' } },
                                { id: 'EGFR_FISH', legend: { group: 'FISH/IHC' } },
                                { id: 'TP53_IHC', legend: { group: 'FISH/IHC' } }
                                ]
                            },
                            ...getGeneTermGroups(),
                        ],
                        // each override may be used by any termwrapper 
                        // that has a tw.overrides[$key] array of any twOverride[$key] below
                        overrides: {
                            SVfill: {
                                value: {
                                    key: 'RNA-Seq', 
                //value: 'RNA-seq', 
                                values: [
                                    { key: 'Not tested', label: 'Not tested', color: '#fff' }
                                ]
                            },
                            sampleFilter: {
                                type: 'tvs',
                                tvs: {
                                    term: { id: 'RNA-Seq' },
                                    values: [{ key: 'No' }]
                                }
                            }
                        },
            /*Germfill: {
              value: {
                key: 'Germline', 
                //value: 'Germline', 
                values: [
                  {key: 'Not tested', label: 'Not tested', color: '#fff', order: 10000}
                ]
              },
              sampleFilter: {
                type: 'tvs', // "wrapper-value-setting"
                tvs: {
                  term: {id: 'Germline'},
                  values: [{key: 'No'}]
                }
              }
            },*/
                        WESfill: {
                            value: {
                                key: 'WES', 
                //value: 'WES', 
                                values: [
                                    { key: 'Not tested', label: 'Not tested', color: '#fff', order: 10000 }
                                ]
                            },
                            sampleFilter: {
                                type: 'tvs', // "wrapper-value-setting"
                                tvs: {
                                    term: { id: 'WES' },
                                    values: [{ key: 'No' }]
                                }
                            }
                        },
                        CNVfill: {
                            value: {
                                key: 'Methylation', 
                                value: 'Methylation', 
                                    values: [
                                        { key: 'Not tested', label: 'Not tested', color: '#fff', order: 10000 }
                                    ]
                                },
                                sampleFilter: {
                                    type: 'tvs', // "wrapper-value-setting"
                                    tvs: {
                                        term: { id: 'Methylation' },
                                        values: [{ key: 'No' }]
                                    }
                                }
                            }
                        }
                    },

                    {
                        chartType: 'survival',
                        term: {
                            id: 'Event-free survival'
                        },
                        settings: {
                            survival: {
                                xTickValues: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30]
                            }
                        }
                    },

                    {
                        chartType: 'survival',
                        term: {
                            id: 'Overall Survival'
                        },
                        // term2: {
                        // 	id: 'Age'
                        // },
                        settings: {
                            survival: {
                                xTickValues: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30]
                            }
                        }
                    }
                ]
            }
        }
    })

        const cnvGenes = `MYCN, PDGFRA,CDKN2A/B, PDGFB, NF1`.split(',').map(g => g.trim())
        function getGeneTermGroups() {
            const termgroups = []
            for (const g of genegroups) {
                const grp = {
                    name: g.name,
                    overrides: g.overrides,
                    valueFilter: g.valueFilter,
                    lst: g.lst.map(t => {
                        const term = { name: t.name, type: 'geneVariant' }
                        const tw = { term }
                        if ('label' in t) tw.label = t.label
                        if ('minNumSamples' in t) tw.minNumSamples = t.minNumSamples
                        return tw
                    })
                }

                if (g.settings) grp.settings = g.settings
                termgroups.push(grp)
            }
            return termgroups
        }

        function getCytogeneticsData() {
            const chrs = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 'X', 'Y']
            const lst = []
            for (const c of chrs) {
                if (c != 13 && c != 14 && c != 15 && c != 21 && c != 22) lst.push({ id: `chr${c}p`, legend: { group: 'Cytogenetics' } })
                lst.push({ id: `chr${c}q`, legend: { group: 'Cytogenetics' } })
            }
            return lst
        }

        const genegroups = [
            {
                "name": "Fusion",
                valueFilter: {
                    type: 'tvs',
                    tvs: {
                        values: [{ key: 'dt', value: 2 }]
                    },
                },
                overrides: ['SVfill'],
                "lst": [
                    {
                        "name": "BCOR_SV",
                    },
                    {
                        "name": "CIC_SV"
                    },
                    {
                        "name": "NTRK1_SV"
                    },
                    {
                        "name": "NTRK3_SV"
                    },
                    {
                        "name": "ROS1_SV"
                    },
                    {
                        "name": "ALK_SV"
                    },
                    {
                        "name": "MET_SV"
                    },
                    {
                        "name": "MYBL1_SV"
                    },
                    {
                        "name": "FGFR2_SV"
                    },
                    {
                        "name": "PDGFRA_SV"
                    },
                    {
                        "name": "PLAGL1_SV"
                    },
                    {
                        "name": "FOXR2_SV"
                    },
                    {
                        "name": "MYB_SV"
                    },
                    {
                        "name": "PATZ1_SV"
                    }
                ]
            },
            {
                name: "Copy Number",
                valueFilter: {
                    type: 'tvs',
                    tvs: {
                        values: [{ key: 'dt', value: 4 }]
                    },
                },
                overrides: ['CNVfill'],
                lst: cnvGenes.map(name => { return { name } })
            },
            {
                "name": "Germline",
                overrides: ['Germfill'],
                "lst": [
                    {
                    "name": "BRCA2_G"
                },
                {
                    "name": "NF1_G"
                }
            ]
            },
            {
                "name": "Somatic",
                "settings": {
                    minNumSamples: 1
                },
                valueFilter: {
                    type: 'tvs',
                    isnot: true,
                    tvs: {
                        values: [{ key: 'dt', value: 4 }]
                    },
                },
                overrides: ['WESfill'],
                "lst": [
                    {
                        "name": "TP53"
                    },
                    {
                        "name": "NF1"
                    },
                    {
                        "name": "H3-3A"
                    },
                    {
                        "name": "H3C2"
                    }
                ]
            }
        ]

</script>

</body>
</html>
